<!-- Overlay -->
<div class="fixed inset-0 bg-black/30 z-40" (click)="onClose()"></div>

<!-- Side panel -->
<div class="fixed right-0 top-0 h-full w-full max-w-lg bg-white shadow-xl z-50 flex flex-col">
  <!-- Header -->
  <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
    <h2 class="text-lg font-semibold text-gray-900">Edit Ticket</h2>
    <button (click)="onClose()" class="text-gray-400 hover:text-gray-600">
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Form -->
  <div class="flex-1 overflow-y-auto px-6 py-4">
    <form [formGroup]="form" (ngSubmit)="onSave()" class="space-y-5">
      <!-- ID (read-only) -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">ID</label>
        <p class="text-sm text-gray-500 font-mono">{{ ticket().id }}</p>
      </div>

      <!-- Title -->
      <div>
        <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
        <input
          id="title"
          formControlName="title"
          type="text"
          class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          [class.border-red-300]="hasError('title', 'required') || hasError('title', 'minlength')"
          [class.border-gray-300]="!hasError('title', 'required') && !hasError('title', 'minlength')"
        />
        @if (hasError('title', 'required')) {
          <p class="mt-1 text-xs text-red-600">Title is required</p>
        }
        @if (hasError('title', 'minlength')) {
          <p class="mt-1 text-xs text-red-600">Title must be at least 10 characters</p>
        }
      </div>

      <!-- Status -->
      <div>
        <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
        <select
          id="status"
          formControlName="status"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          @for (s of STATUSES; track s) {
            <option [value]="s">{{ STATUS_LABELS[s] }}</option>
          }
        </select>
      </div>

      <!-- Blocked Reason (conditional) -->
      @if (showBlockedReason) {
        <div>
          <label for="blockedReason" class="block text-sm font-medium text-gray-700 mb-1">
            Blocked Reason *
          </label>
          <textarea
            id="blockedReason"
            formControlName="blockedReason"
            rows="3"
            class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            [class.border-red-300]="form.hasError('blockedNeedsReason') && form.touched"
            [class.border-gray-300]="!form.hasError('blockedNeedsReason')"
            placeholder="Explain why this ticket is blocked..."
          ></textarea>
          @if (form.hasError('blockedNeedsReason') && form.touched) {
            <p class="mt-1 text-xs text-red-600">A reason is required when status is blocked</p>
          }
        </div>
      }

      <!-- Priority -->
      <div>
        <label for="priority" class="block text-sm font-medium text-gray-700 mb-1">Priority *</label>
        <select
          id="priority"
          formControlName="priority"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          @for (p of PRIORITIES; track p) {
            <option [value]="p">{{ PRIORITY_LABELS[p] }} ({{ p }})</option>
          }
        </select>
      </div>

      <!-- Assignee -->
      <div>
        <label for="assignee" class="block text-sm font-medium text-gray-700 mb-1">
          Assignee
          @if (form.get('priority')?.value === 1) {
            <span class="text-red-500">*</span>
          }
        </label>
        <input
          id="assignee"
          formControlName="assignee"
          type="text"
          class="w-full px-3 py-2 border rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          [class.border-red-300]="form.hasError('priorityOneNeedsAssignee') && form.touched"
          [class.border-gray-300]="!form.hasError('priorityOneNeedsAssignee')"
          placeholder="Assignee name"
        />
        @if (form.hasError('priorityOneNeedsAssignee') && form.touched) {
          <p class="mt-1 text-xs text-red-600">An assignee is required for Critical priority tickets</p>
        }
      </div>

      <!-- Tags -->
      <div>
        <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
        <input
          id="tags"
          formControlName="tags"
          type="text"
          class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="bug, frontend, urgent"
        />
        <p class="mt-1 text-xs text-gray-400">Separate with commas</p>
      </div>
    </form>
  </div>

  <!-- Footer -->
  <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
    <button
      (click)="onClose()"
      type="button"
      class="px-4 py-2 text-sm text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50"
    >
      Cancel
    </button>
    <button
      (click)="onSave()"
      type="button"
      class="px-4 py-2 text-sm text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50"
      [disabled]="form.invalid && form.touched"
    >
      Save Changes
    </button>
  </div>
</div>
